<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard - Notes App</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: #f8fafc; color: #334155; }
        
        .sidebar { position: fixed; left: 0; top: 0; width: 250px; height: 100vh; background: #1e293b; color: #f1f5f9; padding: 20px 0; z-index: 1000; }
        .sidebar h2 { padding: 0 20px; margin-bottom: 30px; color: #60a5fa; font-size: 1.4em; }
        .nav-item { display: block; padding: 15px 20px; color: #cbd5e1; text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #334155; border-left-color: #60a5fa; color: #f1f5f9; }
        .nav-item i { margin-right: 10px; width: 20px; }
        
        .main-content { margin-left: 250px; padding: 20px; min-height: 100vh; }
        .header { background: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .header-flex { display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 2em; color: #1e293b; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .logout-btn { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .logout-btn:hover { background: #dc2626; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2.5em; font-weight: bold; color: #3b82f6; margin-bottom: 5px; }
        .stat-label { color: #6b7280; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .content-section { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px; overflow: hidden; }
        .section-header { padding: 20px 30px; border-bottom: 1px solid #e5e7eb; background: #f9fafb; }
        .section-title { font-size: 1.3em; color: #1e293b; }
        .section-content { padding: 30px; }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; color: #374151; }
        tr:hover { background: #f9fafb; }
        
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 500; }
        .badge-admin { background: #dcfce7; color: #166534; }
        .badge-user { background: #fef3c7; color: #92400e; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        
        .tab-container { margin-bottom: 20px; }
        .tab-buttons { display: flex; border-bottom: 2px solid #e5e7eb; }
        .tab-btn { padding: 15px 25px; background: none; border: none; cursor: pointer; font-size: 1em; color: #6b7280; transition: all 0.2s; }
        .tab-btn.active { color: #3b82f6; border-bottom: 2px solid #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Charts Section with 3D Effects */
        .charts-section { 
            margin-top: 30px; 
            perspective: 1000px;
        }
        .charts-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 25px; 
            margin-bottom: 30px;
            transform-style: preserve-3d;
        }
        .chart-full-width { 
            width: 100%;
            perspective: 1200px;
        }
        .chart-container { 
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px; 
            padding: 25px; 
            box-shadow: 
                0 10px 25px rgba(0,0,0,0.1),
                0 20px 40px rgba(0,0,0,0.05),
                inset 0 1px 0 rgba(255,255,255,0.9);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            transform: rotateX(2deg) rotateY(-1deg);
            transform-style: preserve-3d;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .chart-container:hover {
            transform: rotateX(0deg) rotateY(0deg) translateY(-8px);
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.15),
                0 30px 60px rgba(0,0,0,0.08),
                inset 0 1px 0 rgba(255,255,255,0.95);
        }
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
        }
        .chart-container::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 10px;
            right: 10px;
            height: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            filter: blur(8px);
            transform: scaleY(0.3);
            transition: all 0.4s ease;
        }
        .chart-container:hover::after {
            bottom: -10px;
            filter: blur(12px);
            opacity: 0.8;
        }
        .chart-container h3 { 
            margin-bottom: 20px; 
            color: #334155; 
            font-size: 1.3em;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transform: translateZ(10px);
        }
        .chart-container canvas { 
            max-width: 100%; 
            height: 320px !important;
            width: 100% !important;
            border-radius: 8px;
            transform: translateZ(5px);
        }
        
        /* 3D Stat Cards */
        .stats-grid {
            perspective: 1000px;
            transform-style: preserve-3d;
        }
        .stat-card {
            background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.08),
                0 15px 35px rgba(0,0,0,0.04),
                inset 0 1px 0 rgba(255,255,255,0.9);
            transform: rotateX(3deg) rotateY(-2deg) translateZ(0);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            transform-style: preserve-3d;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
            transform: translateZ(1px);
        }
        .stat-card::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 5px;
            right: 5px;
            height: 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            filter: blur(6px);
            transform: scaleY(0.4) translateZ(-1px);
        }
        .stat-card:hover {
            transform: rotateX(0deg) rotateY(0deg) translateY(-5px) translateZ(10px);
            box-shadow: 
                0 15px 30px rgba(0,0,0,0.12),
                0 25px 50px rgba(0,0,0,0.06),
                inset 0 1px 0 rgba(255,255,255,0.95);
        }
        .stat-card .stat-number {
            font-size: 2.8em !important;
            font-weight: 800 !important;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: translateZ(8px);
        }
        .stat-card .stat-label {
            font-size: 0.95em !important;
            color: #64748b !important;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transform: translateZ(4px);
        }
        
        /* Loading animations */
        .loading {
            opacity: 0.6;
            position: relative;
        }
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* Stat card animations */
        .stat-card {
            animation: slideInUp 0.6s ease-out;
        }
        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Chart container animations */
        .chart-container {
            animation: fadeInScale 0.8s ease-out;
        }
        .charts-grid .chart-container:nth-child(1) { animation-delay: 0.5s; }
        .charts-grid .chart-container:nth-child(2) { animation-delay: 0.7s; }
        .chart-full-width .chart-container { animation-delay: 0.9s; }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* 3D Environment Setup */
        * {
            box-sizing: border-box;
        }
        
        body {
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.15) 0%, transparent 50%),
                linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            background-attachment: fixed;
        }
        
        .main-content {
            overflow-x: hidden;
            position: relative;
        }
        
        .main-content::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, transparent 50%, rgba(255,255,255,0.03) 50%),
                linear-gradient(transparent 50%, rgba(255,255,255,0.03) 50%);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: -1;
        }
        
        .stats-grid, .charts-grid {
            will-change: transform;
        }
        
        /* 3D Floating Animation */
        @keyframes float3D {
            0%, 100% { 
                transform: rotateX(2deg) rotateY(-1deg) translateY(0px) translateZ(0px);
            }
            50% { 
                transform: rotateX(1deg) rotateY(0deg) translateY(-3px) translateZ(5px);
            }
        }
        
        @keyframes floatReverse3D {
            0%, 100% { 
                transform: rotateX(-1deg) rotateY(1deg) translateY(0px) translateZ(0px);
            }
            50% { 
                transform: rotateX(0deg) rotateY(-1deg) translateY(-2px) translateZ(3px);
            }
        }
        
        .chart-container:nth-child(odd) {
            animation: float3D 6s ease-in-out infinite;
        }
        
        .chart-container:nth-child(even) {
            animation: floatReverse3D 8s ease-in-out infinite;
        }
        
        .stat-card:nth-child(1) { animation: float3D 4s ease-in-out infinite; }
        .stat-card:nth-child(2) { animation: floatReverse3D 5s ease-in-out infinite; }
        .stat-card:nth-child(3) { animation: float3D 6s ease-in-out infinite; }
        .stat-card:nth-child(4) { animation: floatReverse3D 7s ease-in-out infinite; }
        
        /* Smooth transitions only for specific properties */
        .chart-container, .stat-card {
            will-change: transform, box-shadow;
        }
        
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .chart-container canvas { 
                height: 250px !important;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>📊 Admin Panel</h2>
        <a href="#dashboard" class="nav-item active" onclick="showTab('dashboard')">
            <i>📈</i> Dashboard
        </a>
        <a href="#users" class="nav-item" onclick="showTab('users')">
            <i>👥</i> Users
        </a>
        <a href="#notes" class="nav-item" onclick="showTab('notes')">
            <i>📝</i> All Notes
        </a>
        <a href="#settings" class="nav-item" onclick="showTab('settings')">
            <i>⚙️</i> Settings
        </a>
    </div>
    
    <div class="main-content">
        <div class="header">
            <div class="header-flex">
                <h1>Admin Dashboard</h1>
                <div class="user-info">
                    <span>Welcome, <strong>Admin</strong></span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="adminUsers">-</div>
                    <div class="stat-label">Admin Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalNotes">-</div>
                    <div class="stat-label">Total Notes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recentNotes">-</div>
                    <div class="stat-label">Recent Notes</div>
                </div>
            </div>
            
            <!-- Animated Charts Section -->
            <div class="charts-section">
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">📊 System Analytics</h2>
                    </div>
                    <div class="section-content">
                        <div class="charts-grid">
                            <div class="chart-container">
                                <h3>User Distribution</h3>
                                <canvas id="userDistributionChart" width="400" height="300"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Notes Activity</h3>
                                <canvas id="notesActivityChart" width="400" height="300"></canvas>
                            </div>
                        </div>
                        <div class="chart-full-width">
                            <div class="chart-container">
                                <h3>User Activity Timeline</h3>
                                <canvas id="activityTimelineChart" width="800" height="400"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Users Tab -->
        <div id="users" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">User Management</h2>
                </div>
                <div class="section-content">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Notes Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notes Tab -->
        <div id="notes" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">All Notes</h2>
                </div>
                <div class="section-content">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="notesTableBody">
                                <!-- Notes will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">System Settings</h2>
                </div>
                <div class="section-content">
                    <p>Settings panel coming soon...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            // Load data based on tab
            if (tabName === 'dashboard') loadStats();
            if (tabName === 'users') loadUsers();
            if (tabName === 'notes') loadNotes();
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/admin/api/stats');
                const stats = await response.json();
                
                // Animate the number changes
                animateNumberChange('totalUsers', stats.total_users);
                animateNumberChange('adminUsers', stats.admin_users);
                animateNumberChange('totalNotes', stats.total_notes);
                animateNumberChange('recentNotes', stats.recent_notes);
                
                // Update charts with new data
                updateCharts(stats);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Animate number changes smoothly
        function animateNumberChange(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent) || 0;
            
            // Only animate if there's a significant change
            if (Math.abs(targetValue - currentValue) < 1) {
                element.textContent = targetValue;
                return;
            }
            
            const difference = targetValue - currentValue;
            const steps = Math.min(15, Math.abs(difference));
            const stepValue = difference / steps;
            
            let currentStep = 0;
            const timer = setInterval(() => {
                currentStep++;
                const newValue = Math.round(currentValue + (stepValue * currentStep));
                element.textContent = newValue;
                
                if (currentStep >= steps) {
                    clearInterval(timer);
                    element.textContent = targetValue;
                }
            }, 80);
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/admin/api/users');
                const users = await response.json();
                
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>
                            <span class="badge ${user.is_admin ? 'badge-admin' : 'badge-user'}">
                                ${user.is_admin ? 'Admin' : 'User'}
                            </span>
                        </td>
                        <td>${user.note_count}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">
                                Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load notes
        async function loadNotes() {
            try {
                const response = await fetch('/admin/api/notes');
                const notes = await response.json();
                
                const tbody = document.getElementById('notesTableBody');
                tbody.innerHTML = notes.map(note => `
                    <tr>
                        <td>${note.id}</td>
                        <td>${note.title}</td>
                        <td>${note.username}</td>
                        <td>${new Date(note.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteNote(${note.id}, '${note.title}')">
                                Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }

        // Delete user
        async function deleteUser(userId, username) {
            if (!confirm(`Are you sure you want to delete user "${username}" and all their notes?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('User deleted successfully');
                    loadUsers();
                    loadStats(); // Refresh stats
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Error deleting user');
            }
        }

        // Delete note
        async function deleteNote(noteId, title) {
            if (!confirm(`Are you sure you want to delete note "${title}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/notes/${noteId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Note deleted successfully');
                    loadNotes();
                    loadStats(); // Refresh stats
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.detail);
                }
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Error deleting note');
            }
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear any stored tokens
                localStorage.removeItem('access_token');
                sessionStorage.removeItem('access_token');
                // Redirect to login
                window.location.href = '/admin/login';
            }
        }

        // Chart instances
        let userDistributionChart, notesActivityChart, activityTimelineChart;

        // Initialize charts with animation
        function initializeCharts() {
            // User Distribution Pie Chart
            const userCtx = document.getElementById('userDistributionChart').getContext('2d');
            
            // Create gradients for pie chart
            const gradient1 = userCtx.createLinearGradient(0, 0, 0, 400);
            gradient1.addColorStop(0, 'rgba(59, 130, 246, 0.9)');
            gradient1.addColorStop(1, 'rgba(29, 78, 216, 0.7)');
            
            const gradient2 = userCtx.createLinearGradient(0, 0, 0, 400);
            gradient2.addColorStop(0, 'rgba(168, 85, 247, 0.9)');
            gradient2.addColorStop(1, 'rgba(124, 58, 237, 0.7)');
            
            userDistributionChart = new Chart(userCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Regular Users', 'Admin Users'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [gradient1, gradient2],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(168, 85, 247, 1)'
                        ],
                        borderWidth: 3,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        animateScale: false,
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // Notes Activity Bar Chart
            const notesCtx = document.getElementById('notesActivityChart').getContext('2d');
            
            // Create gradients for bar chart
            const barGradient1 = notesCtx.createLinearGradient(0, 0, 0, 400);
            barGradient1.addColorStop(0, 'rgba(34, 197, 94, 0.9)');
            barGradient1.addColorStop(1, 'rgba(21, 128, 61, 0.7)');
            
            const barGradient2 = notesCtx.createLinearGradient(0, 0, 0, 400);
            barGradient2.addColorStop(0, 'rgba(251, 191, 36, 0.9)');
            barGradient2.addColorStop(1, 'rgba(217, 119, 6, 0.7)');
            
            const barGradient3 = notesCtx.createLinearGradient(0, 0, 0, 400);
            barGradient3.addColorStop(0, 'rgba(239, 68, 68, 0.9)');
            barGradient3.addColorStop(1, 'rgba(185, 28, 28, 0.7)');
            
            notesActivityChart = new Chart(notesCtx, {
                type: 'bar',
                data: {
                    labels: ['Total Notes', 'Recent Notes', 'Active Users'],
                    datasets: [{
                        label: 'Count',
                        data: [0, 0, 0],
                        backgroundColor: [barGradient1, barGradient2, barGradient3],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(251, 191, 36, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 3,
                        borderRadius: 12,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1200,
                        easing: 'easeInOutQuad'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Activity Timeline Line Chart
            const timelineCtx = document.getElementById('activityTimelineChart').getContext('2d');
            
            // Create gradients for line chart
            const lineGradient1 = timelineCtx.createLinearGradient(0, 0, 0, 400);
            lineGradient1.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
            lineGradient1.addColorStop(1, 'rgba(59, 130, 246, 0.05)');
            
            const lineGradient2 = timelineCtx.createLinearGradient(0, 0, 0, 400);
            lineGradient2.addColorStop(0, 'rgba(34, 197, 94, 0.3)');
            lineGradient2.addColorStop(1, 'rgba(34, 197, 94, 0.05)');
            
            activityTimelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'New Users',
                        data: [10, 15, 25, 20, 30, 35],
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: lineGradient1,
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        pointRadius: 8,
                        pointHoverRadius: 12
                    }, {
                        label: 'New Notes',
                        data: [50, 75, 125, 100, 150, 175],
                        borderColor: 'rgba(34, 197, 94, 1)',
                        backgroundColor: lineGradient2,
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(34, 197, 94, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        pointRadius: 8,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutCubic'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Load detailed chart data
        async function loadChartData() {
            try {
                const response = await fetch('/admin/api/chart-data');
                if (!response.ok) throw new Error('Failed to load chart data');
                
                const data = await response.json();
                updateChartsWithDetailedData(data);
            } catch (error) {
                console.log('Chart data loading error:', error);
                // Fallback to basic stats if detailed data fails
                const statsResponse = await fetch('/admin/api/stats');
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    updateChartsWithBasicStats(stats);
                }
            }
        }

        // Recreate gradients for charts
        function recreateChartGradients() {
            if (userDistributionChart) {
                const userCtx = userDistributionChart.canvas.getContext('2d');
                const gradient1 = userCtx.createLinearGradient(0, 0, 0, 400);
                gradient1.addColorStop(0, 'rgba(59, 130, 246, 0.9)');
                gradient1.addColorStop(1, 'rgba(29, 78, 216, 0.7)');
                
                const gradient2 = userCtx.createLinearGradient(0, 0, 0, 400);
                gradient2.addColorStop(0, 'rgba(168, 85, 247, 0.9)');
                gradient2.addColorStop(1, 'rgba(124, 58, 237, 0.7)');
                
                userDistributionChart.data.datasets[0].backgroundColor = [gradient1, gradient2];
            }
            
            if (notesActivityChart) {
                const notesCtx = notesActivityChart.canvas.getContext('2d');
                const barGradient1 = notesCtx.createLinearGradient(0, 0, 0, 400);
                barGradient1.addColorStop(0, 'rgba(34, 197, 94, 0.9)');
                barGradient1.addColorStop(1, 'rgba(21, 128, 61, 0.7)');
                
                const barGradient2 = notesCtx.createLinearGradient(0, 0, 0, 400);
                barGradient2.addColorStop(0, 'rgba(251, 191, 36, 0.9)');
                barGradient2.addColorStop(1, 'rgba(217, 119, 6, 0.7)');
                
                const barGradient3 = notesCtx.createLinearGradient(0, 0, 0, 400);
                barGradient3.addColorStop(0, 'rgba(239, 68, 68, 0.9)');
                barGradient3.addColorStop(1, 'rgba(185, 28, 28, 0.7)');
                
                notesActivityChart.data.datasets[0].backgroundColor = [barGradient1, barGradient2, barGradient3];
            }
            
            if (activityTimelineChart) {
                const timelineCtx = activityTimelineChart.canvas.getContext('2d');
                const lineGradient1 = timelineCtx.createLinearGradient(0, 0, 0, 400);
                lineGradient1.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
                lineGradient1.addColorStop(1, 'rgba(59, 130, 246, 0.05)');
                
                const lineGradient2 = timelineCtx.createLinearGradient(0, 0, 0, 400);
                lineGradient2.addColorStop(0, 'rgba(34, 197, 94, 0.3)');
                lineGradient2.addColorStop(1, 'rgba(34, 197, 94, 0.05)');
                
                activityTimelineChart.data.datasets[0].backgroundColor = lineGradient1;
                activityTimelineChart.data.datasets[1].backgroundColor = lineGradient2;
            }
        }

        // Update charts with detailed data
        function updateChartsWithDetailedData(data) {
            if (userDistributionChart && data.user_distribution) {
                userDistributionChart.data.labels = data.user_distribution.labels;
                userDistributionChart.data.datasets[0].data = data.user_distribution.data;
                recreateChartGradients();
                userDistributionChart.update('animate');
            }

            if (notesActivityChart && data.stats) {
                notesActivityChart.data.datasets[0].data = [
                    data.stats.total_notes,
                    Math.floor(data.stats.total_notes * 0.3), // Assume 30% are recent
                    data.stats.active_users
                ];
                recreateChartGradients();
                notesActivityChart.update('animate');
            }

            if (activityTimelineChart && data.monthly_activity) {
                activityTimelineChart.data.labels = data.monthly_activity.labels;
                activityTimelineChart.data.datasets[0].data = data.monthly_activity.users;
                activityTimelineChart.data.datasets[1].data = data.monthly_activity.notes;
                recreateChartGradients();
                activityTimelineChart.update('animate');
            }
        }

        // Update charts with basic stats (fallback)
        function updateChartsWithBasicStats(stats) {
            if (userDistributionChart) {
                const regularUsers = (stats.total_users || 0) - (stats.admin_users || 0);
                userDistributionChart.data.datasets[0].data = [regularUsers, stats.admin_users || 0];
                recreateChartGradients();
                userDistributionChart.update('animate');
            }

            if (notesActivityChart) {
                notesActivityChart.data.datasets[0].data = [
                    stats.total_notes || 0,
                    stats.recent_notes || 0,
                    stats.total_users || 0
                ];
                recreateChartGradients();
                notesActivityChart.update('animate');
            }

            // Keep existing timeline data or use simulated data
            if (activityTimelineChart) {
                const currentMonth = new Date().getMonth();
                const userData = activityTimelineChart.data.datasets[0].data;
                const notesData = activityTimelineChart.data.datasets[1].data;
                
                userData[currentMonth % 6] = Math.max(1, Math.floor(stats.total_users / 3));
                notesData[currentMonth % 6] = Math.max(1, Math.floor(stats.total_notes / 2));
                
                recreateChartGradients();
                activityTimelineChart.update('animate');
            }
        }

        // Update charts with real data (legacy function for compatibility)
        function updateCharts(stats) {
            updateChartsWithBasicStats(stats);
        }

        // Auto-refresh charts every 60 seconds (less frequent to reduce animations)
        function startChartAutoRefresh() {
            setInterval(async () => {
                await loadChartData();
            }, 60000);
        }

        // Add 3D glow animation to stat cards
        function animateStatCards() {
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.boxShadow = `
                        0 15px 35px rgba(59, 130, 246, 0.3),
                        0 25px 50px rgba(139, 92, 246, 0.15),
                        inset 0 1px 0 rgba(255,255,255,0.95)`;
                    card.style.transform = 'rotateX(0deg) rotateY(0deg) translateY(-8px) translateZ(15px)';
                    card.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                    
                    setTimeout(() => {
                        card.style.boxShadow = `
                            0 8px 20px rgba(0,0,0,0.08),
                            0 15px 35px rgba(0,0,0,0.04),
                            inset 0 1px 0 rgba(255,255,255,0.9)`;
                        card.style.transform = 'rotateX(3deg) rotateY(-2deg) translateZ(0)';
                    }, 1200);
                }, index * 400);
            });
        }

        // Add 3D mouse tracking effect
        function add3DMouseTracking() {
            const containers = document.querySelectorAll('.chart-container, .stat-card');
            
            containers.forEach(container => {
                container.addEventListener('mousemove', (e) => {
                    const rect = container.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    
                    const rotateX = (y - centerY) / 10;
                    const rotateY = (centerX - x) / 10;
                    
                    container.style.transform = `
                        rotateX(${rotateX}deg) 
                        rotateY(${rotateY}deg) 
                        translateZ(10px)
                        scale3d(1.02, 1.02, 1.02)`;
                });
                
                container.addEventListener('mouseleave', () => {
                    container.style.transform = 'rotateX(2deg) rotateY(-1deg) translateZ(0) scale3d(1, 1, 1)';
                });
            });
        }

        // Initialize dashboard with 3D effects
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            initializeCharts();
            
            // Load detailed chart data after a short delay
            setTimeout(() => {
                loadChartData();
                animateStatCards();
                add3DMouseTracking();
            }, 1000);
            
            startChartAutoRefresh();
            
            // Add entrance animation
            setTimeout(() => {
                document.querySelectorAll('.chart-container').forEach((chart, index) => {
                    chart.style.opacity = '0';
                    chart.style.transform = 'rotateX(90deg) translateY(50px)';
                    chart.style.transition = 'all 1s cubic-bezier(0.4, 0, 0.2, 1)';
                    
                    setTimeout(() => {
                        chart.style.opacity = '1';
                        chart.style.transform = 'rotateX(2deg) rotateY(-1deg) translateY(0)';
                    }, index * 200);
                });
            }, 500);
        });
    </script>
</body>
</html>
